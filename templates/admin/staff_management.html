{% extends "admin/base_admin.html" %}

{% block title %}Staff Management - {{ site_settings.site_name }}{% endblock %}

{% block header_title %}Staff Management{% endblock %}
{% block header_subtitle %}Manage healthcare professionals and administrative staff{% endblock %}

{% block content %}
<div class="mb-8 flex justify-between items-center">
    <div class="relative group">
        <i
            class="ri-search-line absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-brand-500"></i>
        <input type="text" id="staffSearch" placeholder="Search by name, email or role..."
            class="bg-white border border-slate-100 rounded-2xl pl-12 pr-6 py-3.5 text-sm font-medium w-80 outline-none focus:border-brand-500 shadow-sm transition-all shadow-slate-200/50">
    </div>
    <button onclick="openModal('addStaffModal')"
        class="bg-brand-600 hover:bg-brand-700 text-white px-8 py-3.5 rounded-2xl font-bold text-sm transition-all flex items-center gap-2 shadow-lg shadow-brand-900/10">
        <i class="ri-user-add-line"></i> Add New Staff
    </button>
</div>

<!-- Staff Table Card -->
<div class="bg-white rounded-[40px] border border-slate-100 shadow-sm overflow-hidden">
    <table class="w-full text-left" id="staffTable">
        <thead>
            <tr class="bg-slate-50/50 text-[10px] font-black uppercase tracking-widest text-slate-400">
                <th class="px-8 py-5">Staff Member</th>
                <th class="px-8 py-5">Role</th>
                <th class="px-8 py-5">Branch</th>
                <th class="px-8 py-5 text-right">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-50">
            <!-- Doctors -->
            {% for doctor in doctors %}
            <tr class="hover:bg-slate-50/30 transition-colors group">
                <td class="px-8 py-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 bg-emerald-50 rounded-[18px] flex items-center justify-center text-emerald-600 font-bold text-lg">
                            {{ doctor.name[3] if doctor.name.startswith('Dr.') else doctor.name[0] }}
                        </div>
                        <div>
                            <p class="font-black text-slate-900 leading-none">Dr. {{ doctor.name }}</p>
                            <p class="text-xs font-bold text-slate-400 mt-1">{{ doctor.specialization or 'General' }}
                            </p>
                        </div>
                    </div>
                </td>
                <td class="px-8 py-6">
                    <span
                        class="px-3 py-1 bg-emerald-50 text-emerald-700 rounded-lg text-[10px] font-black uppercase tracking-widest">Medical
                        Doctor</span>
                </td>
                <td class="px-8 py-6 text-sm font-bold text-slate-500">
                    {{ branch_lookup.get(doctor.branch_id, {}).get('name', 'General') }}
                </td>
                <td class="px-8 py-6 text-right">
                    <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editStaff('{{ doctor._id }}', 'doctor')"
                            class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-brand-50 hover:text-brand-600 flex items-center justify-center transition-all">
                            <i class="ri-pencil-line"></i>
                        </button>
                        <button onclick="deleteStaff('{{ doctor._id }}', 'doctor')"
                            class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-600 flex items-center justify-center transition-all">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}

            <!-- Receptionists -->
            {% for rec in receptionists %}
            <tr class="hover:bg-slate-50/30 transition-colors group">
                <td class="px-8 py-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 bg-amber-50 rounded-[18px] flex items-center justify-center text-amber-600 font-bold text-lg">
                            {{ rec.name[0] }}
                        </div>
                        <div>
                            <p class="font-black text-slate-900 leading-none">{{ rec.name }}</p>
                            <p class="text-xs font-bold text-slate-400 mt-1">{{ rec.email }}</p>
                        </div>
                    </div>
                </td>
                <td class="px-8 py-6">
                    <span
                        class="px-3 py-1 bg-amber-50 text-amber-700 rounded-lg text-[10px] font-black uppercase tracking-widest">Receptionist</span>
                </td>
                <td class="px-8 py-6 text-sm font-bold text-slate-500">
                    {{ branch_lookup.get(rec.branch_id, {}).get('name', 'N/A') }}
                </td>
                <td class="px-8 py-6 text-right">
                    <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editStaff('{{ rec._id }}', 'receptionist')"
                            class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-brand-50 hover:text-brand-600 flex items-center justify-center transition-all">
                            <i class="ri-pencil-line"></i>
                        </button>
                        <button onclick="deleteStaff('{{ rec._id }}', 'receptionist')"
                            class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-600 flex items-center justify-center transition-all">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}

            <!-- Pharmacists -->
            {% for phar in pharmacists %}
            <tr class="hover:bg-slate-50/30 transition-colors group">
                <td class="px-8 py-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 bg-blue-50 rounded-[18px] flex items-center justify-center text-blue-600 font-bold text-lg">
                            {{ phar.name[0] if phar.name else 'P' }}
                        </div>
                        <div>
                            <p class="font-black text-slate-900 leading-none">{{ phar.name }}</p>
                            <p class="text-xs font-bold text-slate-400 mt-1">{{ phar.email }}</p>
                        </div>
                    </div>
                </td>
                <td class="px-8 py-6">
                    <span
                        class="px-3 py-1 bg-blue-50 text-blue-700 rounded-lg text-[10px] font-black uppercase tracking-widest">Pharmacist</span>
                </td>
                <td class="px-8 py-6 text-sm font-bold text-slate-500">
                    {{ branch_lookup.get(phar.branch_id, {}).get('name', 'N/A') }}
                </td>
                <td class="px-8 py-6 text-right">
                    <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editStaff('{{ phar._id }}', 'pharma')"
                            class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-brand-50 hover:text-brand-600 flex items-center justify-center transition-all">
                            <i class="ri-pencil-line"></i>
                        </button>
                        <button onclick="deleteStaff('{{ phar._id }}', 'pharma')"
                            class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-600 flex items-center justify-center transition-all">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}

            <!-- Lab Assistants -->
            {% for lab in lab_assistants %}
            <tr class="hover:bg-slate-50/30 transition-colors group">
                <td class="px-8 py-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 bg-purple-50 rounded-[18px] flex items-center justify-center text-purple-600 font-bold text-lg">
                            {{ lab.name[0] if lab.name else 'L' }}
                        </div>
                        <div>
                            <p class="font-black text-slate-900 leading-none">{{ lab.name }}</p>
                            <p class="text-xs font-bold text-slate-400 mt-1">{{ lab.email }}</p>
                        </div>
                    </div>
                </td>
                <td class="px-8 py-6">
                    <span
                        class="px-3 py-1 bg-purple-50 text-purple-700 rounded-lg text-[10px] font-black uppercase tracking-widest">Lab
                        Assistant</span>
                </td>
                <td class="px-8 py-6 text-sm font-bold text-slate-500">
                    {{ branch_lookup.get(lab.branch_id, {}).get('name', 'N/A') }}
                </td>
                <td class="px-8 py-6 text-right">
                    <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editStaff('{{ lab._id }}', 'lab')"
                            class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-brand-50 hover:text-brand-600 flex items-center justify-center transition-all">
                            <i class="ri-pencil-line"></i>
                        </button>
                        <button onclick="deleteStaff('{{ lab._id }}', 'lab')"
                            class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-600 flex items-center justify-center transition-all">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Staff Modal -->
<div id="addStaffModal" class="hidden fixed inset-0 z-[100]">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeModal('addStaffModal')"></div>
    <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl bg-white rounded-[40px] shadow-2xl p-10 max-h-[90vh] overflow-y-auto">
        <h3 class="text-2xl font-black text-slate-900 mb-2">Register New Staff</h3>
        <p class="text-slate-400 text-sm font-bold mb-8">Add a new healthcare professional to the system</p>

        <form action="/admin/add_doctor" method="POST" class="space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 ml-4">Staff
                        Type</label>
                    <select name="staff_type" id="staffTypeSelect" onchange="updateFormAction(this.value)" required
                        class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 font-bold text-slate-800 outline-none focus:border-brand-500 appearance-none transition-all">
                        <option value="doctor">Medical Doctor</option>
                        <option value="receptionist">Receptionist</option>
                        <option value="pharma">Pharmacist</option>
                        <option value="lab">Lab Assistant</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 ml-4">Full
                        Name</label>
                    <input type="text" name="name" required placeholder="e.g. John Doe"
                        class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 font-bold text-slate-800 outline-none focus:border-brand-500 transition-all">
                </div>
                <div class="space-y-2">
                    <label
                        class="block text-[10px] font-black uppercase tracking-widest text-slate-400 ml-4">Username</label>
                    <input type="text" name="username" required placeholder="johndoe123"
                        class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 font-bold text-slate-800 outline-none focus:border-brand-500 transition-all">
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 ml-4">Email
                        Address</label>
                    <input type="email" name="email" required placeholder="john@example.com"
                        class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 font-bold text-slate-800 outline-none focus:border-brand-500 transition-all">
                </div>
                <div class="space-y-2">
                    <label
                        class="block text-[10px] font-black uppercase tracking-widest text-slate-400 ml-4">Password</label>
                    <input type="password" name="password" required placeholder="••••••••"
                        class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 font-bold text-slate-800 outline-none focus:border-brand-500 transition-all">
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 ml-4">Assign
                        Branch</label>
                    <select name="branch_id" required
                        class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 font-bold text-slate-800 outline-none focus:border-brand-500 appearance-none transition-all">
                        <option value="">Select Branch</option>
                        {% for branch in branches %}
                        <option value="{{ branch._id }}">{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="specializationField" class="space-y-2">
                    <label
                        class="block text-[10px] font-black uppercase tracking-widest text-slate-400 ml-4">Specialization</label>
                    <input type="text" name="specialization" placeholder="e.g. Cardiology"
                        class="w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 font-bold text-slate-800 outline-none focus:border-brand-500 transition-all">
                </div>
            </div>

            <div class="pt-6 flex gap-4">
                <button type="button" onclick="closeModal('addStaffModal')"
                    class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black text-sm uppercase tracking-widest">Cancel</button>
                <button type="submit"
                    class="flex-1 bg-brand-600 text-white py-4 rounded-2xl font-black text-sm uppercase tracking-widest shadow-lg shadow-brand-900/10 hover:-translate-y-0.5 transition-all">Create
                    Account</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    function updateFormAction(type) {
        const form = document.querySelector('#addStaffModal form');
        const specField = document.getElementById('specializationField');

        if (type === 'doctor') {
            form.action = '/admin/add_doctor';
            specField.style.display = 'block';
            specField.querySelector('input').setAttribute('required', 'required');
        } else {
            specField.style.display = 'none';
            specField.querySelector('input').removeAttribute('required');
            if (type === 'receptionist') form.action = '/admin/add_receptionist';
            else if (type === 'pharma') form.action = '/admin/add_pharma';
            else if (type === 'lab') form.action = '/admin/add_lab_assistant';
        }
    }

    function deleteStaff(id, role) {
        if (confirm(`Are you sure you want to delete this ${role}? This action cannot be undone.`)) {
            let url = '';
            if (role === 'doctor') url = `/admin/delete_doctor/${id}`;
            else if (role === 'receptionist') url = `/admin/delete_receptionist/${id}`;
            else if (role === 'pharma') url = `/admin/delete_pharma/${id}`;
            else if (role === 'lab') url = `/admin/delete_lab_assistant/${id}`;

            if (url) window.location.href = url;
        }
    }

    function editStaff(id, role) {
        window.location.href = `/admin/edit_staff/${role}/${id}`;
    }

    // Search functionality
    document.getElementById('staffSearch').addEventListener('input', function (e) {
        const term = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#staffTable tbody tr');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
    });

    // Initial state
    updateFormAction(document.getElementById('staffTypeSelect').value);
</script>
{% endblock %}